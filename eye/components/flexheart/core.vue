<template>
  <div v-if="activeComponent === 'empty'">
    no active component. wait for a while
  </div>
  <creation v-else-if="activeComponent === 'creation'" ref="creation"/>
</template>

<script>


import Creation from "@/components/flexheart/creation/creation.vue";
import WsConnection from "@/utils/ws_connection";

export default {
  name: "core",
  components: {Creation},
  data() {
    return {
      logPrefix: '❤️',
      status: {
        error: null,
        reconnecting: null,
      },
      maintenance: false,
      connection: null,
      activeComponent: 'empty',
    }
  },
  mounted() {
    if (process.env.SOUL_MAINTENANCE === 'true') {
      this.maintenance = true
      return
    }
    this.connection = new WsConnection(process.env.WS_URL, this.logPrefix, ['creation', 'lottery', 'unity', 'heart'], 100)
    this.connection.onmessage((channel, message) => {
      this.status.error = null
      this.status.reconnecting = null
      // this.message = [channel, message]
      this.onMessage(channel, message)
    })
    this.connection.onerror((err) => {
      this.status.error = err
    })
    this.connection.onreconnecting((attempt, maxAttempts) => {
      console.log(`${this.logPrefix}: RECONNECTING ${attempt}/${maxAttempts}`)
      this.status.reconnecting = {attempt, maxAttempts}
    })
    this.connection.onopen(() => {
      this.status.reconnecting = null
      this.status.error = null
    })
    this.connection.onopen(() => {
      this.status.reconnecting = null
      this.status.error = null
      console.log(`${this.logPrefix}: connection established 🍏`)
    })
    this.connection.connect()
  },
  beforeDestroy() {
    if (!this.maintenance) {
      this.connection.close()
      this.connection = null
    }
  },
  methods: {
    onMessage(channelName, message) {
      // В Сердце может находиться не тот компонент, по которому пришло новое сообщение.
      // Такое бывает, когда режим Архитектора переключается на иную задачу
      // (например, нарисовал и пошёл собирать множество)
      console.log(`${this.logPrefix}: new message`, `channel:${channelName}`, message)

      if (channelName === 'creation' && this.activeComponent !== channelName) {
        this.activeComponent = 'creation'
        setTimeout(() => {
          this.$refs.creation.onMessage(channelName, message)
        }, 100)
      }

      switch (channelName) {
        case 'creation':
        case 'heart':
          if (this.$refs.creation && this.$refs.creation.onMessage) {
            this.$refs.creation.onMessage(channelName, message)
          }
      }
    },
  }
}
</script>


